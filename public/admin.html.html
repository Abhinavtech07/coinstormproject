<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>CoinStorm Admin</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { padding: 2rem; background-color: #f8f9fa; }
    .login-container { max-width: 500px; margin: 5rem auto; padding: 2rem; background: white; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
    .admin-panel { display: none; }
  </style>
</head>
<body>
  <div class="container">
    <div id="login" class="login-container">
      <h2 class="text-center mb-4">CoinStorm Admin</h2>
      <div class="mb-3">
        <label for="password" class="form-label">Admin Password</label>
        <input id="password" type="password" class="form-control">
      </div>
      <button id="loginBtn" class="btn btn-primary w-100">Login</button>
      <div id="loginMessage" class="mt-3 text-danger"></div>
    </div>

    <div id="adminPanel" class="admin-panel">
      <h2 class="mb-4">Admin Dashboard</h2>
      
      <div class="card mb-4">
        <div class="card-header">Create Redeem Codes</div>
        <div class="card-body">
          <div class="row g-3">
            <div class="col-md-6">
              <label for="rewardSelect" class="form-label">Reward</label>
              <select id="rewardSelect" class="form-select"></select>
            </div>
            <div class="col-md-4">
              <label for="codeCount" class="form-label">Quantity</label>
              <input id="codeCount" type="number" class="form-control" value="1" min="1">
            </div>
            <div class="col-md-2 d-flex align-items-end">
              <button id="createCodes" class="btn btn-success w-100">Create</button>
            </div>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
          <span>Issued Codes</span>
          <button id="refreshCodes" class="btn btn-sm btn-outline-secondary">Refresh</button>
        </div>
        <div class="card-body">
          <div class="table-responsive">
            <table class="table table-striped">
              <thead>
                <tr>
                  <th>Code</th>
                  <th>Reward</th>
                  <th>Created At</th>
                </tr>
              </thead>
              <tbody id="codesTable"></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // DOM elements
    const elements = {
      login: document.getElementById('login'),
      adminPanel: document.getElementById('adminPanel'),
      password: document.getElementById('password'),
      loginBtn: document.getElementById('loginBtn'),
      loginMessage: document.getElementById('loginMessage'),
      rewardSelect: document.getElementById('rewardSelect'),
      codeCount: document.getElementById('codeCount'),
      createCodes: document.getElementById('createCodes'),
      refreshCodes: document.getElementById('refreshCodes'),
      codesTable: document.getElementById('codesTable')
    };

    let config = null;
    let redemptionCodes = JSON.parse(localStorage.getItem('redemptionCodes')) || [];

    // Initialize
    document.addEventListener('DOMContentLoaded', async () => {
      // Load config
      const response = await fetch('/config.json')
      config = await response.json()
      
      // Populate reward select
      populateRewardSelect()
      
      // Set up event listeners
      elements.loginBtn.addEventListener('click', handleLogin)
      elements.createCodes.addEventListener('click', handleCreateCodes)
      elements.refreshCodes.addEventListener('click', refreshCodes)
    });

    function populateRewardSelect() {
      elements.rewardSelect.innerHTML = ''
      Object.entries(config.rewards).forEach(([id, reward]) => {
        const option = document.createElement('option')
        option.value = id
        option.textContent = `${reward.name} (${reward.cost} coins)`
        elements.rewardSelect.appendChild(option)
      })
    }

    function handleLogin() {
      const password = elements.password.value.trim()
      
      if (password === config.server.admin_password) {
        elements.login.style.display = 'none'
        elements.adminPanel.style.display = 'block'
        refreshCodes()
      } else {
        showMessage('Invalid password', 'danger')
      }
    }

    function handleCreateCodes() {
      const rewardId = elements.rewardSelect.value
      const count = parseInt(elements.codeCount.value) || 1
      
      if (count < 1 || count > 100) {
        showMessage('Quantity must be between 1 and 100', 'danger')
        return
      }
      
      const newCodes = []
      const now = new Date().toISOString()
      
      for (let i = 0; i < count; i++) {
        const code = generateCode()
        newCodes.push({
          code,
          reward_id: rewardId,
          created_at: now
        })
      }
      
      redemptionCodes = [...newCodes, ...redemptionCodes]
      localStorage.setItem('redemptionCodes', JSON.stringify(redemptionCodes))
      
      showMessage(`Created ${count} codes!`, 'success')
      refreshCodes()
    }

    function generateCode() {
      return Math.random().toString(36).substring(2, 10).toUpperCase() + 
             Math.random().toString(36).substring(2, 6).toUpperCase()
    }

    function refreshCodes() {
      renderCodesTable(redemptionCodes.filter(code => !code.redeemed_at))
    }

    function renderCodesTable(codes) {
      elements.codesTable.innerHTML = ''
      
      if (!codes || codes.length === 0) {
        elements.codesTable.innerHTML = `
          <tr>
            <td colspan="3" class="text-center">No codes issued yet</td>
          </tr>
        `
        return
      }
      
      codes.slice(0, 50).forEach(code => {
        const reward = config.rewards[code.reward_id] || { name: code.reward_id }
        const row = document.createElement('tr')
        row.innerHTML = `
          <td><code>${code.code}</code></td>
          <td>${reward.name}</td>
          <td>${new Date(code.created_at).toLocaleString()}</td>
        `
        elements.codesTable.appendChild(row)
      })
    }

    function showMessage(message, type) {
      elements.loginMessage.textContent = message
      elements.loginMessage.className = `mt-3 text-${type}`
    }
  </script>
</body>
</html>