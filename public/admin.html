
<!doctype html>
<html>
<head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>CoinStorm Admin</title></head>
<body style="font-family:Arial,Helvetica,sans-serif;padding:20px;">
  <h2>CoinStorm Admin</h2>
  <div id="login">
    <p><strong>Enter admin password:</strong></p>
    <input id="pwd" type="password" style="padding:8px;width:240px"><button id="loginBtn">Login</button>
    <p id="loginMsg"></p>
  </div>
  <div id="panel" style="display:none">
    <h3>Create Redeem Codes</h3>
    <select id="rewardSelect"></select>
    <input id="count" type="number" value="1" min="1" style="width:80px">
    <button id="createCodes">Create</button>
    <h3>Recent Issued Codes</h3>
    <pre id="issued"></pre>
    <button id="refreshIssued">Refresh</button>
  </div>

  <script>
    let adminToken = null;
    async function loadRewards() {
      const r = await fetch('/config.json');
      const cfg = await r.json();
      const sel = document.getElementById('rewardSelect');
      sel.innerHTML = '';
      Object.keys(cfg.rewards).forEach(k => {
        const opt = document.createElement('option');
        opt.value = k;
        opt.text = `${cfg.rewards[k].name} (${cfg.rewards[k].cost} coins)`;
        sel.appendChild(opt);
      });
    }
    document.getElementById('loginBtn').addEventListener('click', async ()=>{
      const pwd = document.getElementById('pwd').value;
      const r = await fetch('/api/admin/login',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({password:pwd})});
      const j = await r.json();
      if (!j.ok) { document.getElementById('loginMsg').innerText = j.error || 'Login failed'; return; }
      adminToken = j.adminToken;
      document.getElementById('login').style.display = 'none';
      document.getElementById('panel').style.display = 'block';
      loadRewards();
      refreshIssued();
    });
    document.getElementById('createCodes').addEventListener('click', async ()=>{
      const rewardId = document.getElementById('rewardSelect').value;
      const count = parseInt(document.getElementById('count').value)||1;
      const r = await fetch('/api/admin/create-code',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({rewardId,count,adminToken})});
      const j = await r.json();
      if (j.ok) {
        alert('Created: ' + j.created.join(', '));
        refreshIssued();
      } else alert(j.error || 'Error');
    });
    async function refreshIssued(){
      const r = await fetch('/api/admin/issued',{headers:{'x-admin-token': adminToken}});
      const j = await r.json();
      if (j.ok) document.getElementById('issued').innerText = JSON.stringify(j.rows, null, 2);
    }
    document.getElementById('refreshIssued').addEventListener('click', refreshIssued);
    loadRewards();
  </script>
</body>
</html>
